# v1.45.1 Release Preparation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Prepare v1.45.1 release with accurate documentation and library-user-focused release notes emphasizing under-the-hood performance improvements.

**Architecture:** Sequential phasesâ€”evaluate counts â†’ update README â†’ update white-paper â†’ review â†’ release. Each phase validates before proceeding. Orchestration Mode delegates to specialized agents.

**Tech Stack:** Go toolchain, Make, gh CLI, markdown

---

## Phase 1: README Updates

### Task 1.1: Evaluate Test and Benchmark Counts

**Files:**
- Read: `README.md` (current claims)
- Read: `benchmarks.md` (current benchmark documentation)
- Modify: None yet (evaluation only)

**Step 1: Count test runs (including subtests)**

Run:
```bash
go test -v ./... 2>&1 | grep -c "=== RUN"
```

Record the output as `$TEST_COUNT`.

**Step 2: Count benchmark runs (including sub-benchmarks)**

Run:
```bash
go test -bench=. -benchtime=1x ./... 2>&1 | grep -c "^Benchmark"
```

Record the output as `$BENCHMARK_COUNT`.

**Step 3: Extract current README claims**

Run:
```bash
grep -E "tests|benchmarks" README.md | head -5
```

Document current claims vs actual counts.

**Step 4: Verify speedup claims against benchmarks.md**

Check these specific claims:
- ConvertParsed: README claims "9x faster" â€” find in benchmarks.md
- FixParsed: README claims "~10x faster" â€” find in benchmarks.md
- ApplyParsed: README claims "~15x faster" â€” find in benchmarks.md

Run:
```bash
grep -A5 "ConvertParsed\|FixParsed\|ApplyParsed" benchmarks.md | grep -i "faster"
```

Document verified speedup values.

**Step 5: Report findings to orchestrator**

Provide summary:
- Test count: Current claim â†’ Actual count
- Benchmark count: Current claim â†’ Actual count
- Speedup corrections needed (if any)

---

### Task 1.2: Add Makefile Count Targets

**Files:**
- Modify: `Makefile`

**Step 1: Add count-tests target**

Add to Makefile:
```makefile
.PHONY: count-tests
count-tests: ## Count all test runs including subtests
	@echo "Counting test runs (includes table-driven subtests)..."
	@go test -v ./... 2>&1 | grep -c "=== RUN" || echo "0"
```

**Step 2: Add count-benchmarks target**

Add to Makefile:
```makefile
.PHONY: count-benchmarks
count-benchmarks: ## Count all benchmark runs including sub-benchmarks
	@echo "Counting benchmark runs (includes parameterized cases)..."
	@go test -bench=. -benchtime=1x ./... 2>&1 | grep -c "^Benchmark" || echo "0"
```

**Step 3: Verify targets work**

Run:
```bash
make count-tests
make count-benchmarks
```

Expected: Both output numbers matching Task 1.1 findings.

**Step 4: Commit Makefile changes**

```bash
git add Makefile
git commit -m "chore: add count-tests and count-benchmarks Make targets"
```

---

### Task 1.3: Update README Counts and Add Footnote

**Files:**
- Modify: `README.md`

**Step 1: Update test count**

Find and replace the test count claim with the verified value from Task 1.1.

**Step 2: Update benchmark count**

Find and replace the benchmark count claim with the verified value from Task 1.1.

**Step 3: Add methodology footnote**

Add after the counts (in the appropriate section):
```markdown
<sup>â€ </sup> Test count includes table-driven subtests. Benchmark count includes parameterized sub-benchmarks. Run `make count-tests` and `make count-benchmarks` to verify.
```

**Step 4: Verify old values are gone**

Run:
```bash
grep -n "7,300\|140+" README.md
```

Expected: No matches (old values removed).

**Step 5: Verify new values exist**

Run:
```bash
grep -n "tests\|benchmarks" README.md | head -5
```

Expected: New verified counts appear.

---

### Task 1.4: Update README Speedup Claims

**Files:**
- Modify: `README.md`

**Step 1: Update ConvertParsed speedup**

If benchmarks.md shows different value than "9x faster", update the README table.

**Step 2: Update FixParsed speedup**

If benchmarks.md shows different value than "~10x faster", update the README table.

**Step 3: Update ApplyParsed speedup**

If benchmarks.md shows different value than "~15x faster", update or verify the README table.

**Step 4: Verify consistency**

Run:
```bash
grep -E "[0-9]+x faster" README.md
grep -E "[0-9]+x faster" benchmarks.md
```

Confirm README claims match benchmarks.md data.

---

### Task 1.5: Add New Features to README

**Files:**
- Modify: `README.md`

**Step 1: Add sync.Pool to Highlights section**

Find the Highlights/Features section and add:
```markdown
- **Optimized Memory Usage** â€” sync.Pool reduces GC pressure up to 36% fewer allocations in marshal operations
```

**Step 2: Add order-preserving marshal mention**

In appropriate section add:
```markdown
- **Deterministic Output** â€” Order-preserving marshal for reproducible JSON/YAML output
```

**Step 3: Add Equals methods mention**

In the Type-Safe Cloning section or similar, add:
```markdown
All OAS types also provide `Equals()` methods for structural comparison.
```

**Step 4: Commit README changes**

```bash
git add README.md
git commit -m "docs(readme): update counts, speedups, add v1.44-v1.45 features

- Fix test/benchmark counts with verified values
- Add methodology footnote for reproducibility
- Update speedup claims to match benchmarks.md
- Add sync.Pool, order-preserving marshal, Equals mentions"
```

---

## Phase 2: White-paper Updates

### Task 2.1: Update White-paper Version Header

**Files:**
- Modify: `docs/whitepaper.md`

**Step 1: Update version**

Find the "Current as of:" line (near line 5) and change from `v1.37.0` to `v1.45.1`.

**Step 2: Verify change**

Run:
```bash
grep -n "Current as of\|v1.37\|v1.45" docs/whitepaper.md | head -3
```

Expected: Shows v1.45.1, no v1.37.0.

---

### Task 2.2: Add Package Chaining Section

**Files:**
- Modify: `docs/whitepaper.md`

**Step 1: Find insertion point**

The new section goes after Section 3 (Architecture) and before individual package sections. Find the line number.

Run:
```bash
grep -n "^## " docs/whitepaper.md | head -10
```

**Step 2: Insert Package Chaining section**

Add new section:
```markdown
## Package Chaining

oastools packages are designed for seamless composition. Each package's result type provides a `ToParseResult()` method, enabling fluid pipelines without manual rewrapping:

```go
result, _ := parser.Parse("spec.yaml", false, true)

// Chain through the entire toolchain without losing context
validated := validator.ValidateParsed(result, true, false)
fixed := fixer.FixParsed(validated.ToParseResult())
converted := converter.ConvertParsed(fixed.ToParseResult(), "3.1.0")
joined := joiner.JoinParsed(converted.ToParseResult(), other.ToParseResult())
```

| Package | Result Type | Provides ToParseResult() |
|---------|-------------|-------------------------|
| validator | `ValidationResult` | âœ… v1.41.0 |
| fixer | `FixResult` | âœ… v1.41.0 |
| converter | `ConvertResult` | âœ… v1.40.0 |
| joiner | `JoinResult` | âœ… v1.40.0 |

This pattern eliminates boilerplate and preserves metadata (source path, OAS version, parse options) throughout the pipeline.
```

**Step 3: Verify insertion**

Run:
```bash
grep -n "Package Chaining\|ToParseResult" docs/whitepaper.md
```

Expected: New section appears.

---

### Task 2.3: Update Parser Section

**Files:**
- Modify: `docs/whitepaper.md`

**Step 1: Find Parser section**

Run:
```bash
grep -n "^## .*Parser\|^### .*Parser" docs/whitepaper.md
```

**Step 2: Add Equals methods subsection**

Add in Parser section:
```markdown
### Structural Comparison

All OAS types provide `Equals()` methods for deep structural comparison:

```go
if doc1.Equals(doc2) {
    fmt.Println("Documents are structurally identical")
}
```

This is useful for detecting changes, caching decisions, and test assertions.
```

**Step 3: Add order-preserving marshal subsection**

Add in Parser section:
```markdown
### Deterministic Output

The `MarshalOrderedJSON()` and `MarshalOrderedYAML()` functions produce deterministic output by preserving key order. This ensures:
- Reproducible diffs between versions
- Consistent output for CI/CD pipelines
- Predictable test snapshots
```

---

### Task 2.4: Update Other Package Sections

**Files:**
- Modify: `docs/whitepaper.md`

**Step 1: Update Validator section**

Add note about `--validate-structure` CLI flag for controlling parser validation behavior.

**Step 2: Update Fixer section**

Add subsections:
- Duplicate operationId detection and automatic renaming
- CSV enum string expansion to typed arrays

**Step 3: Update Joiner section**

Add note about source name warnings in collision messages for debugging clarity.

---

### Task 2.5: Update Walker Section (Summary + Link)

**Files:**
- Modify: `docs/whitepaper.md`

**Step 1: Find Walker section**

Run:
```bash
grep -n "^## .*Walker\|^### .*Walker" docs/whitepaper.md
```

**Step 2: Add enhancements summary**

Add at end of Walker section:
```markdown
### Recent Enhancements (v1.38â€“v1.45)

The walker has gained several powerful features:

- **Reference Tracking** â€” `WithRefHandler()` and `WithMapRefTracking()` for comprehensive `$ref` detection
- **Parent Tracking** â€” `WithParentTracking()` provides type-safe ancestor access via `ParentInfo`
- **Post-Visit Hooks** â€” `WithSchemaPostHandler()`, `WithOperationPostHandler()`, etc. for bottom-up processing
- **Built-in Collectors** â€” `CollectSchemas()` and `CollectOperations()` reduce boilerplate

For comprehensive documentation, examples, and performance considerations, see the [Walker Deep Dive](packages/walker.md).
```

**Step 3: Verify link target exists**

Run:
```bash
ls -la docs/packages/walker.md
```

Expected: File exists.

---

### Task 2.6: Add Performance Section Updates

**Files:**
- Modify: `docs/whitepaper.md`

**Step 1: Find Performance section**

Run:
```bash
grep -n "^## .*Performance\|^### .*Performance" docs/whitepaper.md
```

**Step 2: Add sync.Pool subsection**

Add:
```markdown
### Memory Optimization: sync.Pool (v1.45.0)

The parser and generator packages use `sync.Pool` to reduce GC pressure:

**Marshal Buffer Pool** (parser):
- Reuses `bytes.Buffer` for JSON/YAML marshaling
- Up to 36% fewer allocations for large documents
- 78x faster buffer acquisition vs allocation

**Template Buffer Pool** (generator):
- Tiered pools (8KB/32KB/64KB) based on operation count
- Prevents oversized allocations during code generation

**Design Decisions:**
- All pools are internal (package-private)
- Reset-on-get pattern ensures clean state
- Size guards prevent memory leaks from oversized objects
- 7 planned pools were cut (YAGNI) due to use-after-put risks

Capacity decisions are data-driven from corpus analysis of 10 real-world OpenAPI specs (19,147 operations, 360,577 schemas).
```

---

### Task 2.7: Commit White-paper Changes

**Step 1: Review all changes**

Run:
```bash
git diff docs/whitepaper.md | head -100
```

**Step 2: Commit**

```bash
git add docs/whitepaper.md
git commit -m "docs(whitepaper): update to v1.45.1 with accumulated features

- Add Package Chaining section (ToParseResult pipeline pattern)
- Parser: add Equals methods, order-preserving marshal
- Validator: add --validate-structure flag
- Fixer: add duplicate operationId, CSV enum expansion
- Joiner: add source name warnings
- Walker: add summary of v1.38-v1.45 enhancements with deep dive link
- Performance: add sync.Pool optimization details"
```

---

## Phase 3: Review and Release

### Task 3.1: Maintainer Review

**Files:**
- Review: All changes from Phase 1 and Phase 2

**Step 1: Run make check**

```bash
make check
```

Expected: All checks pass.

**Step 2: Review documentation changes**

Have maintainer agent review:
- README.md changes for accuracy
- whitepaper.md changes for completeness
- No broken links
- Consistent messaging

**Step 3: Address any feedback**

If maintainer requests changes, apply them before proceeding.

---

### Task 3.2: Prepare Release

**Step 1: Invoke prepare-release skill**

Use `/prepare-release v1.45.1` with custom release notes:

```markdown
## v1.45.1

### ðŸš€ Performance: Faster with Zero Code Changes

This release delivers significant under-the-hood improvements. Your existing code runs fasterâ€”no changes required.

**sync.Pool Optimizations**
- Up to **36% fewer memory allocations** during marshal operations
- **78x faster** buffer acquisition in hot paths
- Reduced GC pressure for high-throughput workloads
- Data-driven: capacities tuned from corpus of 10 real-world specs (19K+ operations)

**What we didn't ship** (and why that matters):
We designed 12 pools, implemented 3. Seven were cut because they risked use-after-put bugs. We chose safety over micro-optimizations.

### ðŸ“š Documentation Refresh

- README: Corrected benchmark counts, updated speedup claims with verified data
- White-paper: Updated to v1.45.1 with 8 versions of accumulated features
- New "Package Chaining" section documenting the `ToParseResult()` pipeline pattern

### ðŸ”§ Internal Only

- No public API changes
- No breaking changes
- Full backward compatibility
```

**Step 2: Follow prepare-release prompts**

The skill will handle:
- CI benchmark runs
- Tag creation
- GitHub release publishing

---

## Verification Checklist

After all tasks complete, verify:

- [ ] `make count-tests` output matches README claim
- [ ] `make count-benchmarks` output matches README claim
- [ ] README speedup claims match benchmarks.md
- [ ] White-paper shows "Current as of: v1.45.1"
- [ ] Package Chaining section exists in white-paper
- [ ] Walker section links to deep dive document
- [ ] `make check` passes
- [ ] v1.45.1 release published on GitHub
