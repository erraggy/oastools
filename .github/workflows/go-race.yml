# Race Detection Workflow
# Runs tests with race detector enabled (-race flag)
# This is resource-intensive (2-20x slower) so it runs on a schedule rather than on every PR

name: Race Detection

on:
  schedule:
    # Run nightly at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:  # Allow manual triggering
  push:
    branches: [ "main" ]
    paths:
      - '**.go'
      - 'go.mod'
      - 'go.sum'

permissions:
  contents: read

jobs:

  race-test:
    runs-on: ubuntu-latest
    timeout-minutes: 30  # Race detector is slower (2-20x), allow more time
    steps:
    - uses: actions/checkout@v6

    - name: Set up Go
      uses: actions/setup-go@v6
      with:
        go-version: '1.24'
        cache: true

    - name: Test with Race Detector
      timeout-minutes: 25  # Step-level timeout (slightly higher than go test timeout)
      run: go test -v -race -timeout=20m -parallel=2 -skip='^Fuzz' ./...
      env:
        GOMAXPROCS: 2  # Limit parallelism to avoid overwhelming the runner
        GORACE: "halt_on_error=1"  # Exit immediately on first race for faster feedback
