package generator

import (
	"bytes"
	"fmt"
)

// OIDCDiscoveryGenerator generates OpenID Connect discovery client code.
type OIDCDiscoveryGenerator struct {
	// PackageName is the Go package name for generated code.
	PackageName string
}

// NewOIDCDiscoveryGenerator creates a new OIDCDiscoveryGenerator.
func NewOIDCDiscoveryGenerator(packageName string) *OIDCDiscoveryGenerator {
	return &OIDCDiscoveryGenerator{
		PackageName: packageName,
	}
}

// GenerateOIDCDiscoveryFile generates the oidc_discovery.go file.
func (g *OIDCDiscoveryGenerator) GenerateOIDCDiscoveryFile(discoveryURL string) string {
	var buf bytes.Buffer

	// Header and imports
	buf.WriteString(fmt.Sprintf(`// Code generated by oastools. DO NOT EDIT.

package %s

import (
	"context"
	"encoding/json"
	"fmt"
	"net/http"
	"sync"
	"time"
)

`, g.PackageName))

	// OIDC Configuration struct
	buf.WriteString(g.generateOIDCConfiguration())

	// OIDC Discovery Client
	buf.WriteString(g.generateOIDCDiscoveryClient(discoveryURL))

	// Helper function to create OAuth2 client from OIDC config
	buf.WriteString(g.generateOIDCOAuth2Helper())

	return buf.String()
}

// generateOIDCConfiguration generates the OIDCConfiguration struct.
func (g *OIDCDiscoveryGenerator) generateOIDCConfiguration() string {
	return `// OIDCConfiguration represents the OpenID Connect Discovery document.
// See: https://openid.net/specs/openid-connect-discovery-1_0.html
type OIDCConfiguration struct {
	// Issuer is the OP's Issuer Identifier (required).
	Issuer string ` + "`json:\"issuer\"`" + `

	// AuthorizationEndpoint is the URL of the OP's Authorization Endpoint.
	AuthorizationEndpoint string ` + "`json:\"authorization_endpoint\"`" + `

	// TokenEndpoint is the URL of the OP's Token Endpoint.
	TokenEndpoint string ` + "`json:\"token_endpoint\"`" + `

	// UserinfoEndpoint is the URL of the OP's UserInfo Endpoint.
	UserinfoEndpoint string ` + "`json:\"userinfo_endpoint,omitempty\"`" + `

	// JwksURI is the URL of the OP's JSON Web Key Set document.
	JwksURI string ` + "`json:\"jwks_uri\"`" + `

	// RegistrationEndpoint is the URL of the OP's Dynamic Client Registration Endpoint.
	RegistrationEndpoint string ` + "`json:\"registration_endpoint,omitempty\"`" + `

	// ScopesSupported is a list of the OAuth 2.0 scope values supported.
	ScopesSupported []string ` + "`json:\"scopes_supported,omitempty\"`" + `

	// ResponseTypesSupported is a list of the OAuth 2.0 response_type values supported.
	ResponseTypesSupported []string ` + "`json:\"response_types_supported\"`" + `

	// ResponseModesSupported is a list of the OAuth 2.0 response_mode values supported.
	ResponseModesSupported []string ` + "`json:\"response_modes_supported,omitempty\"`" + `

	// GrantTypesSupported is a list of the OAuth 2.0 grant_type values supported.
	GrantTypesSupported []string ` + "`json:\"grant_types_supported,omitempty\"`" + `

	// TokenEndpointAuthMethodsSupported is a list of Client Authentication methods.
	TokenEndpointAuthMethodsSupported []string ` + "`json:\"token_endpoint_auth_methods_supported,omitempty\"`" + `

	// RevocationEndpoint is the URL of the OP's OAuth 2.0 Token Revocation Endpoint.
	RevocationEndpoint string ` + "`json:\"revocation_endpoint,omitempty\"`" + `

	// IntrospectionEndpoint is the URL of the OP's OAuth 2.0 Token Introspection Endpoint.
	IntrospectionEndpoint string ` + "`json:\"introspection_endpoint,omitempty\"`" + `

	// EndSessionEndpoint is the URL of the OP's Logout Endpoint.
	EndSessionEndpoint string ` + "`json:\"end_session_endpoint,omitempty\"`" + `

	// CodeChallengeMethodsSupported is a list of PKCE code challenge methods supported.
	CodeChallengeMethodsSupported []string ` + "`json:\"code_challenge_methods_supported,omitempty\"`" + `
}

`
}

// generateOIDCDiscoveryClient generates the OIDC discovery client.
func (g *OIDCDiscoveryGenerator) generateOIDCDiscoveryClient(discoveryURL string) string {
	var buf bytes.Buffer

	// Default discovery URL constant
	if discoveryURL != "" {
		buf.WriteString(fmt.Sprintf(`// DefaultOIDCDiscoveryURL is the default OpenID Connect discovery URL.
const DefaultOIDCDiscoveryURL = %q

`, discoveryURL))
	}

	buf.WriteString(`// OIDCDiscoveryClient fetches and caches OpenID Connect configuration.
type OIDCDiscoveryClient struct {
	discoveryURL string
	httpClient   *http.Client
	cacheTTL     time.Duration

	mu           sync.RWMutex
	config       *OIDCConfiguration
	lastFetched  time.Time
}

// OIDCDiscoveryOption configures the OIDC discovery client.
type OIDCDiscoveryOption func(*OIDCDiscoveryClient)

// WithOIDCHTTPClient sets a custom HTTP client for discovery requests.
func WithOIDCHTTPClient(client *http.Client) OIDCDiscoveryOption {
	return func(c *OIDCDiscoveryClient) {
		c.httpClient = client
	}
}

// WithOIDCCacheTTL sets the cache TTL for the discovery document.
// Default is 1 hour. Set to 0 to disable caching.
func WithOIDCCacheTTL(ttl time.Duration) OIDCDiscoveryOption {
	return func(c *OIDCDiscoveryClient) {
		c.cacheTTL = ttl
	}
}

// NewOIDCDiscoveryClient creates a new OIDC discovery client.
// The discoveryURL should be the issuer URL; "/.well-known/openid-configuration"
// will be appended automatically if not present.
func NewOIDCDiscoveryClient(discoveryURL string, opts ...OIDCDiscoveryOption) *OIDCDiscoveryClient {
	c := &OIDCDiscoveryClient{
		discoveryURL: discoveryURL,
		httpClient:   http.DefaultClient,
		cacheTTL:     time.Hour,
	}
	for _, opt := range opts {
		opt(c)
	}
	return c
}

// GetConfiguration fetches the OIDC configuration, using cached data if available.
func (c *OIDCDiscoveryClient) GetConfiguration(ctx context.Context) (*OIDCConfiguration, error) {
	// Check cache first
	c.mu.RLock()
	if c.config != nil && c.cacheTTL > 0 && time.Since(c.lastFetched) < c.cacheTTL {
		config := c.config
		c.mu.RUnlock()
		return config, nil
	}
	c.mu.RUnlock()

	// Fetch fresh configuration
	c.mu.Lock()
	defer c.mu.Unlock()

	// Double-check after acquiring write lock
	if c.config != nil && c.cacheTTL > 0 && time.Since(c.lastFetched) < c.cacheTTL {
		return c.config, nil
	}

	config, err := c.fetchConfiguration(ctx)
	if err != nil {
		return nil, err
	}

	c.config = config
	c.lastFetched = time.Now()
	return config, nil
}

// fetchConfiguration fetches the OIDC configuration from the discovery URL.
func (c *OIDCDiscoveryClient) fetchConfiguration(ctx context.Context) (*OIDCConfiguration, error) {
	url := c.discoveryURL
	// Append well-known path if not present
	if len(url) > 0 && url[len(url)-1] != '/' {
		url += "/"
	}
	url += ".well-known/openid-configuration"

	req, err := http.NewRequestWithContext(ctx, http.MethodGet, url, nil)
	if err != nil {
		return nil, fmt.Errorf("failed to create OIDC discovery request: %w", err)
	}
	req.Header.Set("Accept", "application/json")

	resp, err := c.httpClient.Do(req)
	if err != nil {
		return nil, fmt.Errorf("failed to fetch OIDC configuration: %w", err)
	}
	defer resp.Body.Close()

	if resp.StatusCode != http.StatusOK {
		return nil, fmt.Errorf("OIDC discovery returned status %d", resp.StatusCode)
	}

	var config OIDCConfiguration
	if err := json.NewDecoder(resp.Body).Decode(&config); err != nil {
		return nil, fmt.Errorf("failed to decode OIDC configuration: %w", err)
	}

	return &config, nil
}

// ClearCache clears the cached configuration.
func (c *OIDCDiscoveryClient) ClearCache() {
	c.mu.Lock()
	defer c.mu.Unlock()
	c.config = nil
	c.lastFetched = time.Time{}
}

// SupportsScope checks if a scope is supported by the OIDC provider.
func (c *OIDCDiscoveryClient) SupportsScope(ctx context.Context, scope string) (bool, error) {
	config, err := c.GetConfiguration(ctx)
	if err != nil {
		return false, err
	}
	for _, s := range config.ScopesSupported {
		if s == scope {
			return true, nil
		}
	}
	return false, nil
}

// SupportsGrantType checks if a grant type is supported by the OIDC provider.
func (c *OIDCDiscoveryClient) SupportsGrantType(ctx context.Context, grantType string) (bool, error) {
	config, err := c.GetConfiguration(ctx)
	if err != nil {
		return false, err
	}
	for _, gt := range config.GrantTypesSupported {
		if gt == grantType {
			return true, nil
		}
	}
	return false, nil
}

// SupportsPKCE checks if PKCE (Proof Key for Code Exchange) is supported.
func (c *OIDCDiscoveryClient) SupportsPKCE(ctx context.Context) (bool, error) {
	config, err := c.GetConfiguration(ctx)
	if err != nil {
		return false, err
	}
	return len(config.CodeChallengeMethodsSupported) > 0, nil
}

`)

	return buf.String()
}

// generateOIDCOAuth2Helper generates helper to create OAuth2 client from OIDC config.
func (g *OIDCDiscoveryGenerator) generateOIDCOAuth2Helper() string {
	return `// OAuth2ConfigFromOIDC creates an OAuth2 configuration from OIDC discovery.
// This function fetches the OIDC configuration and extracts the OAuth2 endpoints.
type OAuth2ConfigFromOIDCOptions struct {
	// ClientID is the OAuth2 client identifier.
	ClientID string
	// ClientSecret is the OAuth2 client secret (optional for public clients).
	ClientSecret string
	// RedirectURL is the URL to redirect to after authorization.
	RedirectURL string
	// Scopes are the OAuth2 scopes to request.
	Scopes []string
}

// GetOAuth2ConfigFromOIDC fetches OIDC configuration and returns OAuth2 endpoints.
func GetOAuth2ConfigFromOIDC(ctx context.Context, discoveryURL string) (authURL, tokenURL string, err error) {
	client := NewOIDCDiscoveryClient(discoveryURL)
	config, err := client.GetConfiguration(ctx)
	if err != nil {
		return "", "", fmt.Errorf("failed to get OIDC configuration: %w", err)
	}
	return config.AuthorizationEndpoint, config.TokenEndpoint, nil
}

// WithOIDCDiscovery creates a ClientOption that sets up OAuth2 authentication
// using endpoints discovered from an OIDC provider.
// The tokenFunc is called before each request to get the current access token.
func WithOIDCDiscovery(discoveryURL string, tokenFunc func(ctx context.Context) (string, error)) ClientOption {
	return func(c *Client) error {
		c.RequestEditors = append(c.RequestEditors, func(ctx context.Context, req *http.Request) error {
			token, err := tokenFunc(ctx)
			if err != nil {
				return fmt.Errorf("failed to get token: %w", err)
			}
			req.Header.Set("Authorization", "Bearer "+token)
			return nil
		})
		return nil
	}
}
`
}
